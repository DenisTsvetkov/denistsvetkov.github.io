<!DOCTYPE html>
<html lang="ru">
<head>
	<meta charset="UTF-8">
	<title>Экспертная система</title>
	<link rel="stylesheet" href="css/main.css">
</head>
<body>

<div class="program">
	<table class="table">
	  <thead class="thead-dark">
	    <tr>
	    </tr>
	  </thead>
	  <tbody>
	    <tr>
	    </tr>
	  </tbody>
	</table>

	<div class="element-control">
		<input type="file" value="Загрузить модель" multiple>
		<button id="btn-save-model">Сохранить модель</button>
		<div class="input-cyber-cybe">
			<label for="cyber-cube">Оставать на грани гиперкуба: </label>
			<input type="checkbox" id='cyber-cube' checked>
		</div>
		<button id="btn-learn-model">Обучить модель</button>
		<button id="btn-clean-model">Сбросить модель</button>
		<button id="btn-check-model">Проверка</button>
	</div>
	
</div>

<script src="js/jquery-3.3.1.min.js"></script>
	<script>
		
		function checkboxToPropsArray(table){
			var result = [];

			$(table+' tbody tr input[type=checkbox]').each(function(index, element){
				$(element).prop('checked') ? result[index] = 1: result[index] = 0;
			});

			return result;
		}

		var objects = {
			'props': [
				'Компьютер не включается',
				'Медленно работает',
				'Появляется синий экран',
				'Перезагружается',
				'ОС не загружается',
				'Сбивается время',
				'Не работают порты ',
				'Компьютер сильно греется',
				'Нет изображения',
				'Искажения изображения',
				],
			'0':
				{
					'name': 'Поврежден процессор',
					'props': [1,0,0,1,1,0,0,1,0,0]
				},
			'1':
				{
					'name': 'Проблемы с оперативной памятью',
					'props': [1,0,1,1,0,0,0,0,0,0]
				},
			'2':
				{	
					'name': 'Сломана видеокарта',
					'props': [0,0,0,0,0,0,0,0,1,1]
				},
			'3':
				{
					'name': 'Сломана материнская плата',
					'props': [1,0,0,1,1,0,1,0,0,0]
				},
			'4':
				{
					'name': 'Возможно нужно переустановить ОС',
					'props': [0,1,0,0,0,0,0,0,0,0]
				},
			'5':
				{
					'name': 'Неисправен блок питания',
					'props': [1,0,0,1,0,0,0,0,0,0]
				},
			'6':
				{
					'name': 'Неисправен жесткий диск',
					'props': [0,1,1,0,1,0,0,0,0,0]
				},
			'7':
				{
					'name': 'Требуется замена батарейки',
					'props': [0,0,0,1,0,1,0,0,0,0]
				}
		}

		var countObjects = Object.keys(objects).length - 1;
		var countProps = objects.props.length;

		// var initialModel = [
		//   [0, 0, 0, 0, 0, 0, 0, 0],
		//   [0, 0, 0, 0, 0, 0, 0, 0],
		//   [0, 0, 0, 0, 0, 0, 0, 0],
		//   [0, 0, 0, 0, 0, 0, 0, 0],
		//   [0, 0, 0, 0, 0, 0, 0, 0],
		//   [0, 0, 0, 0, 0, 0, 0, 0],
		//   [0, 0, 0, 0, 0, 0, 0, 0],
		//   [0, 0, 0, 0, 0, 0, 0, 0],
		//   [0, 0, 0, 0, 0, 0, 0, 0],
		//   [0, 0, 0, 0, 0, 0, 0, 0]
		// ];

		var initialModel = [];
		for(var i=0; i<countProps;i++){
			initialModel[i]=[];
			for (var j = 0; j < countObjects; j++) {
				initialModel[i][j] = 0;
			}
		}

		class ExpertModel{
			constructor(matrix, cyber_cube) {
				this.matrix = matrix;
				this.cyber_cube = cyber_cube;
			}

			getNameObject(object){
				var count = Object.keys(objects).length;
				for(var i=0; i < count; i++) {
				    if(objects[i] == object) {
				      return i;
				    }
				}
			}

			get count_object(){
				return Object.keys(objects).length-1;
			} 

			get count_prop(){
				return this.matrix.length;
			}

			cleanModel(){
				for(var i=0; i < this.count_prop; i++){
					for(var j=0; j < this.count_object; j++){
						this.matrix[i][j]=0;
					}
				}
			}

			learnNewObject(object){
				var newMatrix = this.matrix;
				
				for(var i=0; i < this.count_prop; i++){
					for(var j=0; j < this.count_object; j++){
						if(j==this.getNameObject(object)){
							newMatrix[i][j] += object.props[i];
						}
						else{
							newMatrix[i][j] -= object.props[i];
						}
					}
				}

				this.matrix = newMatrix;

				if(this.cyber_cube == true){
					this.returnOnBrinkCybercube();
				}
				
			}

			showModel(){
				console.log(this.matrix);
			}

			showModelTable(table){
				$(table+' thead tr th').detach();
				$(table+' tbody tr').detach();
				for(var i=0; i<this.count_object; i++){
					$(table+' thead tr').append( "<th scope='col'>"+objects[i].name+"</th>");

				}
				for(var i=0;i<this.count_prop; i++){
					$(table+' tbody').append("<tr></tr>");
					for(var j=0;j<this.count_object; j++){
						$(table+' tbody tr:nth-child('+(i+1)+')').append("<td>"+this.matrix[i][j]+"</td>");
					}
				}

				$(table+' thead tr').append( "<th scope='col'>Признак</th>");
				for(var i=0; i < this.count_prop; i++){
					$(table+' tbody tr:nth-child('+(i+1)+')').append("<td>"+objects.props[i]+"</td>");
				}

				//$(table+' thead tr').append( "<th scope='col'>Признак</th>");
				for(var i=0; i < this.count_prop; i++){
					$(table+' tbody tr:nth-child('+(i+1)+')').append("<td><input type='checkbox' data-prop='"+i+"'></td>");
				}
				
			}

			returnOnBrinkCybercube(){
				for(var i=0; i < this.count_prop; i++){
					for(var j=0; j < this.count_object; j++){
						if(this.matrix[i][j] < -1){
							this.matrix[i][j] = -1;
						}
						else if(this.matrix[i][j] > 1){
							this.matrix[i][j] = 1;
						}
					}
				}
			}

			specifyObject(props){
				var demons = [];

				for(var i = 0; i < this.count_object; i++){
					demons[i]=0;
					for(var j=0; j < this.count_prop; j++){
						demons[i] += props[j]*this.matrix[j][i];
					}
				}
				
				var maxElem = Math.max.apply(null, demons);
				console.log(demons);
				//console.log('Максимальный демон: '+maxElem);
				return demons.indexOf(maxElem);

			}
		}

		
		//model.showModelTable('.table');
		let model = new ExpertModel(initialModel, $('#cyber-cube').prop('checked'));
		model.showModelTable('.table');
		// $('#cyber-cube').on('change', function(){
		// 	let model = new ExpertModel(initialModel, $('#cyber-cube').prop('checked'));
		// });
		
		$('#btn-learn-model').on('click', function(){
			model.cyber_cube = $('#cyber-cube').prop('checked');
			for(var i=0; i < model.count_object; i++){
				model.learnNewObject(objects[i]);
			}
			model.showModelTable('.table');
		});

		$('#btn-clean-model').on('click', function(){
			model.cleanModel();
			model.showModelTable('.table');
		});
		
		$('#btn-check-model').on('click', function(){
			var elem = model.specifyObject(checkboxToPropsArray('.table'));
			alert("Скорее всего это: "+objects[elem].name+"\n\n");
		});
		
		$('#btn-save-model').on('click', function() {
		    
		    var data = JSON.stringify(objects);

		    var blob = new Blob( [ data ], {
		        type: 'application/octet-stream'
		    });
		    
		    url = URL.createObjectURL( blob );
		    var link = document.createElement('a');
		    link.setAttribute( 'href', url );
		    link.setAttribute( 'download', 'expert_model.json' );
		    
		    var event = document.createEvent( 'MouseEvents' );
		    event.initMouseEvent( 'click', true, true, window, 1, 0, 0, 0, 0, false, false, false, false, 0, null);
		    link.dispatchEvent(event);
		});
		

		

		// $('button').click(function(){
		// 	checkboxToPropsArray('.table');
		// });

	</script>
</body>
</html>